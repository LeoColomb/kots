icon: https://github.com/okteto/polling/raw/master/icon.png
deploy:
  - |
    curl -s -L "https://github.com/loft-sh/vcluster/releases/latest" | sed -nE 's!.*"([^"]*vcluster-linux-amd64)".*!https://github.com\1!p' | xargs -n 1 curl -L -o vcluster && chmod +x vcluster
    sudo mv vcluster /usr/local/bin
    vcluster create vcluster -n ${OKTETO_NAMESPACE} --upgrade
    okteto build -f ./okteto.Dockerfile -t okteto.dev/kotsadm:${OKTETO_GIT_COMMIT} .
    okteto build -f ./web/okteto.Dockerfile --build-arg OKTETO_NAMESPACE=${OKTETO_NAMESPACE} -t okteto.dev/kotsadm-web:${OKTETO_GIT_COMMIT} web
    okteto build -f ./migrations/okteto.Dockerfile -t okteto.dev/kotsadm-migrations:${OKTETO_GIT_COMMIT} migrations
    okteto build -f ./kurl_proxy/okteto.Dockerfile -t okteto.dev/kurl_proxy:${OKTETO_GIT_COMMIT} kurl_proxy
  - |
    cd kustomize/overlays/okteto
    kustomize edit set image kotsadm=okteto.dev/kotsadm:${OKTETO_GIT_COMMIT}
    kustomize edit set image kotsadm-web=okteto.dev/kotsadm-web:${OKTETO_GIT_COMMIT}
    kustomize edit set image migrations=okteto.dev/kotsadm-migrations:${OKTETO_GIT_COMMIT}
  - |
    kubectl wait --for=condition=Ready pod/vcluster-0
    kubectl cp vcluster-0:/data/k3s-config/kube-config.yaml ./kube-config.yaml
  - kubectl exec -it vcluster-0 kubectl create ns ${OKETO_NAMESPACE}
  - kubectl apply -k kustomize/overlays/okteto --dry-run=client -oyaml | kubectl exec -it vcluster-0 kubectl apply -f -

#  - kubectl apply -s https://vcluster-${OKTETO_NAMESPACE}.replicated.okteto.dev/ --kubeconfig ./kube-config.yaml -k kustomize/overlays/okteto

#  - okteto build -f ./okteto.Dockerfile -t okteto.dev/kotsadm:${OKTETO_GIT_COMMIT} .
#  - okteto build -f ./web/okteto.Dockerfile --build-arg OKTETO_NAMESPACE=${OKTETO_NAMESPACE} -t okteto.dev/kotsadm-web:${OKTETO_GIT_COMMIT} web
#  - okteto build -f ./migrations/okteto.Dockerfile -t okteto.dev/kotsadm-migrations:${OKTETO_GIT_COMMIT} migrations
#  - okteto build -f ./kurl_proxy/okteto.Dockerfile -t okteto.dev/kurl_proxy:${OKTETO_GIT_COMMIT} kurl_proxy
#
#  - cd kustomize/overlays/okteto && kustomize edit set image kotsadm=okteto.dev/kotsadm:${OKTETO_GIT_COMMIT}
#  - cd kustomize/overlays/okteto && kustomize edit set image kotsadm-web=okteto.dev/kotsadm-web:${OKTETO_GIT_COMMIT}
#  - cd kustomize/overlays/okteto && kustomize edit set image migrations=okteto.dev/kotsadm-migrations:${OKTETO_GIT_COMMIT}
#  - cd kustomize/overlays/okteto && kustomize edit set image kurl_proxy=okteto.dev/kurl_proxy:${OKTETO_GIT_COMMIT}
#
#  - kubectl apply -k kustomize/overlays/okteto

